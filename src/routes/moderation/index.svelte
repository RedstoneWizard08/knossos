<script lang="ts">
    import { page } from "$app/stores";
    import NoData from "$assets/images/illustrations/undraw_no_data.svg";
    import Badge from "$components/elements/Badge.svelte";
    import Button from "$components/elements/Button.svelte";
    import ProjectCard from "$components/elements/ProjectCard.svelte";
    import { ago } from "$lib/ago";
    import { send } from "$lib/api";
    import { markdownXSS } from "$lib/parse";
    import { popups } from "$stores/app";
    import { getContext } from "svelte";
    import { t } from "svelte-intl-precompile";
    import IconEye from "virtual:icons/heroicons-outline/eye";
    import IconTrash from "virtual:icons/heroicons-outline/trash";
    import IconCalendar from "virtual:icons/lucide/calendar";

    let items = getContext("items");

    let filteredItems: [];
    $: filteredItems = items.filter((item) =>
        $page.url.searchParams.get("type")
            ? item.moderation_type === $page.url.searchParams.get("type")
            : true
    );

    async function changeStatus(id) {
        $popups = [
            {
                title: "Change project status",
                type: {
                    moderation: {
                        id,
                    },
                },
                button: {
                    label: "Confirm",
                    click: async ({ status, body }) => {
                        await send("PATCH", `project/${id}`, {
                            status,
                            ...(body
                                ? {
                                      moderation_message: "Moderator message",
                                      moderation_message_body: body,
                                  }
                                : {}),
                        });
                        removeItem(id);
                    },
                },
            },
            ...$popups,
        ];
    }

    function removeItem(id) {
        items = items.filter((item) => item.id !== id);
    }
</script>

{#if filteredItems.length > 0}
    {#each filteredItems as item}
        {#if item.moderation_type === "report"}
            <div class="card report">
                <div class="report__info">
                    <div class="report__info__title">
                        <h3>
                            {item.item_type}
                            <a href={item.url}>{item.item_id}</a>
                        </h3>
                        reported by<a href="/user/{item.reporter}"
                            >{item.reporter}</a
                        >
                    </div>
                    {#if item.body}
                        {@html markdownXSS(item.body)}
                    {/if}
                    <Badge
                        label="Marked as {item.report_type}"
                        color="yellow"
                    />
                </div>
                <div class="actions">
                    <Button
                        label="Delete report"
                        icon={IconTrash}
                        on:click={async () => {
                            await send("DELETE", `report/${item.id}`);
                            removeItem(item.id);
                        }}
                    />
                    <span class="stat">
                        <IconCalendar />
                        {@html $t("stats.created", {
                            values: { ago: ago(item.created) },
                        })}
                    </span>
                </div>
            </div>
        {:else}
            <ProjectCard project={item}>
                <div slot="actions" class="actions">
                    <Button
                        label="Change status"
                        on:click={() => changeStatus(item.id)}
                        icon={IconEye}
                    />
                    <span class="stat">
                        <IconCalendar />
                        {@html $t("stats.created", {
                            values: { ago: ago(item.published) },
                        })}
                    </span>
                </div>
            </ProjectCard>
        {/if}
    {/each}
{:else}
    <div class="illustration">
        <NoData class="illustration__image" />
        <p class="illustration__description">You are up to date!</p>
    </div>
{/if}

<style lang="postcss">
    .report {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        flex-wrap: wrap;
        grid-gap: 1rem;

        > div {
            display: flex;
            flex-direction: column;
            grid-gap: 0.75rem;
        }

        &__info {
            display: flex;
            flex-wrap: wrap;

            &__title {
                display: flex;
                align-items: center;
                grid-gap: 0.5rem;
                flex-wrap: wrap;

                h3 {
                    text-transform: capitalize;
                }

                a {
                    text-decoration: underline;
                }
            }
        }
    }
</style>
